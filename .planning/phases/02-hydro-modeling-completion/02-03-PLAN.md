---
phase: 02-hydro-modeling-completion
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - src/constraints/hydro_water_balance.jl
  - test/unit/test_hydro_water_balance.jl
autonomous: true

must_haves:
  truths:
    - "Water balance constraints use loaded inflow data instead of hardcoded zeros"
    - "Cascade delays correctly add upstream outflows at time t-delay"
    - "Unit conversion 0.0036 factor is applied (m³/s to hm³ per hour)"
    - "Headwater plants have no upstream terms, only natural inflow"
    - "Terminal plants have no downstream, outflow exits system"
  artifacts:
    - path: "src/constraints/hydro_water_balance.jl"
      provides: "Complete water balance with cascade and inflows"
      contains: "build_cascade_topology"
      min_lines: 350
  key_links:
    - from: "cascade_topology.jl"
      to: "hydro_water_balance.jl"
      via: "build_cascade_topology()"
      pattern: "build_cascade_topology"
    - from: "InflowData"
      to: "hydro_water_balance.jl"
      via: "inflow lookup by plant_id"
      pattern: "inflow_data\\.inflows|get_inflow"
    - from: "upstream outflow"
      to: "downstream balance"
      via: "q[upstream_idx, t - delay] * M3S_TO_HM3_PER_HOUR"
      pattern: "t - round.*delay"
---

<objective>
Complete water balance constraints with cascade topology integration and loaded inflow data.

Purpose: Enable realistic multi-reservoir hydro modeling by connecting the cascade topology utility and inflow data loading to the water balance constraint builder. Replace hardcoded zeros with actual inflows and implement upstream water tracking with travel time delays.

Output: Updated hydro_water_balance.jl with cascade logic (lines 224-228 uncommented and completed), loaded inflows (replacing lines 204, 242, 257), and comprehensive tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-hydro-modeling-completion/02-CONTEXT.md
@.planning/phases/02-hydro-modeling-completion/02-RESEARCH.md
@src/constraints/hydro_water_balance.jl
@src/utils/cascade_topology.jl
@src/data/loaders/dessem_loader.jl
</context>

<tasks>

<task type="auto">
  <name>Integrate cascade topology into water balance constraints</name>
  <files>src/constraints/hydro_water_balance.jl</files>
  <action>
Modify `src/constraints/hydro_water_balance.jl` to use cascade topology:

1. **Add import for cascade topology** (at top of file, after existing imports):
   ```julia
   # Import cascade topology utilities
   using ..CascadeTopology: build_cascade_topology, CascadeTopology
   ```

2. **Update build!() function** to build cascade topology at start:
   After line 182 (`plant_dict = Dict(p.id => p for p in all_hydro)`), add:
   ```julia
   # Build cascade topology for upstream lookups
   cascade_topology = build_cascade_topology(all_hydro)
   ```

3. **Replace the commented cascade logic** (lines 223-228):
   Current code:
   ```julia
   # Cascade: add upstream outflow
   if constraint.include_cascade && plant.downstream_plant_id !== nothing
       # This plant receives water from upstream
       # The constraint would be added to the downstream plant
       # This is a simplified version - full cascade requires topology traversal
   end
   ```
   
   Replace with complete cascade logic INSIDE the water balance constraint (not separate):
   The water balance for each plant should ADD upstream outflows.
   
   In the water balance constraint for each plant (after line 219 or similar):
   ```julia
   # Add upstream outflows with travel time delays
   if constraint.include_cascade
       upstream_plants = get(cascade_topology.upstream_map, plant.id, Tuple{String,Float64}[])
       for (upstream_id, delay_hours) in upstream_plants
           t_upstream = t - round(Int, delay_hours)
           
           # Only add if delayed time is within valid range (avoid negative indices)
           if t_upstream >= 1
               upstream_idx = plant_indices[upstream_id]
               upstream_outflow_hm3 = q[upstream_idx, t_upstream] * M3S_TO_HM3_PER_HOUR
               
               # Add spillage if included
               if constraint.include_spill && spill !== nothing
                   upstream_outflow_hm3 += spill[upstream_idx, t_upstream] * M3S_TO_HM3_PER_HOUR
               end
               
               balance_expr += upstream_outflow_hm3
           end
           # For t_upstream < 1: water from before horizon, handled by initial conditions
       end
   end
   ```

4. **Key insight**: The cascade logic should be added to the DOWNSTREAM plant's water balance constraint, not the upstream plant's constraint. The upstream_map in CascadeTopology gives us the plants that flow INTO a given plant.

5. **Update the water balance constraint structure**:
   The constraint should be:
   ```
   s[plant, t] = s[plant, t-1] + natural_inflow - outflow - spill + upstream_outflows_with_delay
   ```

   Where `upstream_outflows_with_delay` = sum of q[upstream, t-delay] * M3S_TO_HM3_PER_HOUR for all upstream plants.

</action>
  <verify>
Commands:
```bash
# Check for cascade topology import
grep -q "build_cascade_topology" src/constraints/hydro_water_balance.jl && echo "Cascade topology imported"

# Check for cascade_topology variable
grep -q "cascade_topology = build_cascade_topology" src/constraints/hydro_water_balance.jl && echo "Cascade topology built"

# Check for upstream delay logic
grep -q "t_upstream = t - round" src/constraints/hydro_water_balance.jl && echo "Delay logic found"

# Check for upstream_map usage
grep -q "upstream_map" src/constraints/hydro_water_balance.jl && echo "Upstream map used"

# Run existing tests
julia --project=test -e 'using Test; include("test/runtests.jl")'
```
</verify>
  <done>Cascade topology integrated into water balance constraint builder. Upstream outflows added with travel time delays using t - round(Int, delay_hours). M3S_TO_HM3_PER_HOUR conversion applied.</done>
</task>

<task type="auto">
  <name>Replace hardcoded inflows with loaded data</name>
  <files>src/constraints/hydro_water_balance.jl</files>
  <action>
Replace the three `inflow = 0.0` hardcoded values with actual loaded data:

1. **Add inflow_data parameter to build!()**:
   Update function signature to accept inflow data:
   ```julia
   function build!(
       model::Model,
       system::ElectricitySystem,
       constraint::HydroWaterBalanceConstraint;
       inflow_data::Union{InflowData,Nothing} = nothing,
       hydro_plant_numbers::Union{Dict{String,Int},Nothing} = nothing,
   )
   ```

2. **Create helper function for inflow lookup**:
   ```julia
   """
       get_inflow_for_period(inflow_data, hydro_plant_numbers, plant_id, t) -> Float64

   Get inflow in m³/s for a specific plant and time period.

   Returns 0.0 if no inflow data available.
   """
   function get_inflow_for_period(inflow_data, hydro_plant_numbers, plant_id, t)
       if inflow_data === nothing || hydro_plant_numbers === nothing
           return 0.0
       end
       
       plant_num = get(hydro_plant_numbers, plant_id, nothing)
       if plant_num === nothing
           return 0.0
       end
       
       inflows = get(inflow_data.inflows, plant_num, nothing)
       if inflows === nothing || t > length(inflows)
           return 0.0
       end
       
       return inflows[t]
   end
   ```

3. **Replace line 204** (ReservoirHydro inflow):
   ```julia
   # OLD: inflow = 0.0  # TODO: Load from data
   # NEW:
   inflow_m3s = get_inflow_for_period(inflow_data, hydro_plant_numbers, plant.id, t)
   inflow_hm3 = inflow_m3s * M3S_TO_HM3_PER_HOUR
   ```
   
   Update constraint expression to use `inflow_hm3` instead of `inflow`.

4. **Replace line 242** (RunOfRiverHydro inflow):
   ```julia
   # OLD: inflow = 0.0  # TODO: Load from data
   # NEW:
   inflow_m3s = get_inflow_for_period(inflow_data, hydro_plant_numbers, plant.id, t)
   ```
   
   Update constraint to use `inflow_m3s`.

5. **Replace line 257** (PumpedStorageHydro inflow):
   ```julia
   # OLD: inflow = 0.0
   # NEW:
   inflow_m3s = get_inflow_for_period(inflow_data, hydro_plant_numbers, plant.id, t)
   inflow_hm3 = inflow_m3s * M3S_TO_HM3_PER_HOUR
   ```
   
   Update constraint expression to use `inflow_hm3`.

6. **Update docstring** to document the new optional parameters.

7. **Ensure backward compatibility**: If inflow_data is not provided, fall back to 0.0 (current behavior).
</action>
  <verify>
Commands:
```bash
# Check for inflow_data parameter
grep -q "inflow_data" src/constraints/hydro_water_balance.jl && echo "inflow_data parameter found"

# Check that hardcoded zeros are removed
grep -v "inflow = 0.0" src/constraints/hydro_water_balance.jl | grep -q "inflow" && echo "Hardcoded zeros replaced"

# Check for get_inflow_for_period helper
grep -q "get_inflow_for_period" src/constraints/hydro_water_balance.jl && echo "Helper function found"

# Run existing tests
julia --project=test -e 'using Test; include("test/runtests.jl")'
```
</verify>
  <done>Hardcoded inflow=0.0 at lines 204, 242, 257 replaced with get_inflow_for_period() lookup. Inflow data passed via optional parameters. Unit conversion M3S_TO_HM3_PER_HOUR applied. Backward compatible (defaults to 0.0 if no data).</done>
</task>

<task type="auto">
  <name>Add comprehensive tests for cascade water balance</name>
  <files>test/unit/test_hydro_water_balance.jl</files>
  <action>
Create or update test file `test/unit/test_hydro_water_balance.jl` with comprehensive tests:

1. **Test cascade topology integration**:
   ```julia
   @testset "Cascade Water Balance" begin
       # Create a simple cascade: H001 -> H002 -> H003
       h1 = ReservoirHydro(; id="H001", name="Upstream", ...)
       h2 = ReservoirHydro(; id="H002", name="Middle", downstream_plant_id="H001", water_travel_time_hours=2.0, ...)
       h3 = ReservoirHydro(; id="H003", name="Downstream", downstream_plant_id="H002", water_travel_time_hours=1.0, ...)
       
       # Build model and constraints
       # Verify upstream outflows appear in downstream balance
   end
   ```

2. **Test inflow loading integration**:
   ```julia
   @testset "Inflow Data Integration" begin
       # Create mock inflow data
       inflow_data = InflowData(Dict(1 => [10.0, 11.0, 12.0]), 3, Date(2025, 1, 1))
       hydro_plant_numbers = Dict("H001" => 1)
       
       # Build constraint with inflow data
       # Verify inflows are used in balance constraints
   end
   ```

3. **Test edge cases**:
   ```julia
   @testset "Edge Cases" begin
       @testset "Headwater plant (no upstream)" begin
           # Plant with no upstream should only have natural inflow
       end
       
       @testset "Terminal plant (no downstream)" begin
           # Plant with no downstream should have outflow exit system
       end
       
       @testset "Delay bounds checking" begin
           # t=1 with delay=2 should not cause negative index
       end
   end
   ```

4. **Test unit conversion**:
   ```julia
   @testset "Unit Conversion" begin
       # Verify 1 m³/s * 0.0036 = 0.0036 hm³/hour
       @test 100.0 * 0.0036 ≈ 0.36
   end
   ```

Run tests to ensure all pass.
</action>
  <verify>
Commands:
```bash
# Check test file exists
test -f test/unit/test_hydro_water_balance.jl && echo "Test file exists"

# Run the specific test file
julia --project=test -e 'using Test; include("test/unit/test_hydro_water_balance.jl")'

# Run all tests
julia --project=test -e 'using Test; include("test/runtests.jl")'
```
</verify>
  <done>Test suite covers cascade topology integration, inflow data loading, edge cases (headwater, terminal, delay bounds), and unit conversion. All tests pass.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build water balance constraints for a 3-plant cascade system
2. Verify upstream outflows appear in downstream constraints with correct delay
3. Load inflow data from sample dadvaz.dat and verify it's used in constraints
4. Test headwater plant has no upstream terms
5. Test terminal plant outflow exits system
6. Test delay bounds (t=1, delay=2 should not crash)
7. Verify unit conversion (m³/s to hm³ with 0.0036 factor)
8. All existing tests pass (1100+)
</verification>

<success_criteria>
- Cascade topology integrated via build_cascade_topology() call
- Upstream outflows added with travel time delays (t - round(Int, delay))
- Hardcoded inflow=0.0 replaced with loaded data at lines 204, 242, 257
- Unit conversion M3S_TO_HM3_PER_HOUR applied consistently
- Headwater plants have no upstream terms
- Terminal plants have outflow exiting system
- Comprehensive tests cover all edge cases
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-hydro-modeling-completion/02-03-SUMMARY.md`
</output>
