---
phase: 01-objective-function-completion
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
files_modified:
  - src/objective/production_cost.jl
  - test/unit/test_production_cost_objective.jl
autonomous: true

must_haves:
  truths:
    - "Objective function uses FCF water values for terminal period storage"
    - "All cost coefficients are scaled by 1e-6 for numerical stability"
    - "Load shedding cost term is correctly added when variables exist"
    - "Deficit cost term is correctly added when variables exist"
  artifacts:
    - path: "src/objective/production_cost.jl"
      provides: "Complete production cost objective with FCF and scaling"
      contains: "COST_SCALE"
      min_lines: 550
    - path: "test/unit/test_production_cost_objective.jl"
      provides: "Test coverage for objective function"
  key_links:
    - from: "src/objective/production_cost.jl"
      to: "src/data/loaders/fcf_loader.jl"
      via: "FCFCurveData in build_objective! signature"
      pattern: "FCFCurveData|get_water_value"
    - from: "src/objective/production_cost.jl"
      to: "src/variables/variable_manager.jl"
      via: "model[:shed] and model[:deficit] access"
      pattern: ":shed|:deficit"
---

<objective>
Complete the production cost objective function with FCF water values and numerical scaling.

Purpose: The objective function must correctly value water at terminal periods using FCF curves (which represent future opportunity cost), and all cost coefficients must be scaled to prevent numerical instability in the solver. This completes the OBJ-01, OBJ-02, OBJ-03, and OBJ-04 requirements.

Output: Modified production_cost.jl with FCF integration, numerical scaling constant, and complete test coverage.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/objective/production_cost.jl
@src/data/loaders/fcf_loader.jl
@src/variables/variable_manager.jl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add numerical scaling constant and apply to all costs</name>
  <files>src/objective/production_cost.jl</files>
  <action>
Modify src/objective/production_cost.jl:

1. **Add COST_SCALE constant** at top of file (after module docstring):
```julia
"""
    COST_SCALE

Numerical scaling factor for objective function coefficients.
Applied to prevent solver instability from large cost magnitudes.

Typical costs in Brazilian system:
- Fuel costs: 100-500 R$/MWh
- Startup costs: 10,000-100,000 R$
- Water values: 50-200 R$/hmÂ³

Scaling by 1e-6 reduces magnitudes to manageable levels while
preserving relative differences between cost components.
"""
const COST_SCALE = 1e-6
```

2. **Apply scaling to all cost terms in build!() function**:
   - Thermal fuel cost: `cost * COST_SCALE * g[idx, t]`
   - Thermal startup cost: `plant.startup_cost_rs * COST_SCALE * v[idx, t]`
   - Thermal shutdown cost: `plant.shutdown_cost_rs * COST_SCALE * w[idx, t]`
   - Hydro water value: `water_value * COST_SCALE * s[idx, t]`
   - Curtailment penalty: `penalty * COST_SCALE * curtail[idx, t]`
   - Load shedding: `penalty * COST_SCALE * shed[...]`
   - Deficit: `penalty * COST_SCALE * deficit[...]`

3. **Update docstring** to document scaling behavior

4. **Do NOT scale** the cost_component_summary values - keep these in original R$ for reporting
  </action>
  <verify>
- COST_SCALE = 1e-6 constant exists
- All objective expression terms include * COST_SCALE
- Docstring updated to mention scaling
- cost_component_summary still in original R$ (not scaled)
  </verify>
  <done>
All objective coefficients scaled by COST_SCALE = 1e-6 for solver stability.
</done>
</task>

<task type="auto">
  <name>Task 2: Integrate FCF curves for terminal water value</name>
  <files>src/objective/production_cost.jl</files>
  <action>
Modify src/objective/production_cost.jl:

1. **Add import** for FCF types:
```julia
using ..FCFLoader: FCFCurveData, get_water_value
```

2. **Modify ProductionCostObjective struct** to accept FCF data:
```julia
Base.@kwdef struct ProductionCostObjective <: AbstractObjective
    metadata::ObjectiveMetadata
    # ... existing fields ...
    fcf_data::Union{FCFCurveData, Nothing} = nothing  # NEW: Optional FCF curves
    use_terminal_water_value::Bool = true              # NEW: Use FCF for terminal period
end
```

3. **Modify build!() function signature**:
```julia
function build!(
    model::Model,
    system::ElectricitySystem,
    objective::ProductionCostObjective;
    fcf_data::Union{FCFCurveData, Nothing} = objective.fcf_data  # Allow override
)
```

4. **Update Hydro Water Value section** in build!():
   - Get terminal time period: `T = last(time_periods)`
   - For each plant at each time period:
     - If t == T and fcf_data provided: use `get_water_value(fcf_data, plant.id, s[idx, T])`
     - Else: use `plant.water_value_rs_per_hm3` (existing behavior)
   - Log when FCF water values are used

5. **Update calculate_cost_breakdown()** similarly:
   - Accept optional fcf_data parameter
   - Use FCF water value for terminal period if available
  </action>
  <verify>
- ProductionCostObjective has fcf_data field
- build!() uses FCF water value for terminal period when fcf_data provided
- Fallback to plant.water_value_rs_per_hm3 when no FCF data
- calculate_cost_breakdown handles FCF water values
  </verify>
  <done>
FCF curves integrated for terminal period water value calculation.
</done>
</task>

<task type="auto">
  <name>Task 3: Fix load shedding and deficit cost terms</name>
  <files>src/objective/production_cost.jl</files>
  <action>
Modify src/objective/production_cost.jl - fix the load shedding and deficit sections:

1. **Fix Load Shedding Cost section** (currently around line 333-352):
   - Current code checks for model[:shed] but indexing is wrong
   - Fix indexing: `shed[load_idx, t]` where load_idx from load index mapping
   - Add helper `get_load_indices(system)` if not exists
   - Apply COST_SCALE to shedding penalty

2. **Fix Deficit Cost section** (currently around line 354-372):
   - Current code checks for model[:deficit] but indexing is wrong  
   - Fix indexing: `deficit[submarket_idx, t]`
   - Use submarket indices from Variables module
   - Apply COST_SCALE to deficit penalty

3. **Update warnings**:
   - Change warning text from "optional variable" to something more informative
   - Suggest calling create_load_shedding_variables!() if variable missing

4. **Import get_submarket_indices** from Variables module if needed
  </action>
  <verify>
- Load shedding term correctly indexes model[:shed][load_idx, t]
- Deficit term correctly indexes model[:deficit][submarket_idx, t]
- Both terms use COST_SCALE
- Clear warnings when variables not found
  </verify>
  <done>
Load shedding and deficit cost terms correctly use new variables with proper indexing.
</done>
</task>

<task type="auto">
  <name>Task 4: Create comprehensive test suite</name>
  <files>test/unit/test_production_cost_objective.jl</files>
  <action>
Create test/unit/test_production_cost_objective.jl:

1. **Test COST_SCALE application**:
   - Build objective, verify scaled coefficients in objective expression
   - Compare with unscaled version, confirm 1e-6 factor difference
   - Verify cost_component_summary is NOT scaled

2. **Test FCF integration**:
   - Create mock FCFCurveData with test curves
   - Build objective with fcf_data
   - Verify terminal period uses FCF water value
   - Verify non-terminal periods use plant.water_value_rs_per_hm3

3. **Test load shedding**:
   - Create model with shed variables
   - Enable load_shedding_cost in objective
   - Verify shed cost term appears in objective

4. **Test deficit**:
   - Create model with deficit variables
   - Enable deficit_cost in objective
   - Verify deficit cost term appears

5. **Test complete objective**:
   - Build objective with all cost terms enabled
   - Verify all expected cost components in summary
   - Verify objective is minimization sense

6. **Test calculate_cost_breakdown**:
   - With mock solved model values
   - Verify breakdown matches expected values

Follow existing test patterns (use @testset, @test macros).
  </action>
  <verify>
Run: julia --project=test -e 'include("test/unit/test_production_cost_objective.jl")'
All tests pass
  </verify>
  <done>
Comprehensive test coverage for production cost objective with >90% coverage.
</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `julia --project=test test/runtests.jl` passes including new objective tests
2. COST_SCALE = 1e-6 applied to all cost coefficients
3. FCF water values used for terminal period when fcf_data provided
4. Load shedding and deficit cost terms work correctly
5. All 5 Phase 1 success criteria from ROADMAP.md satisfied:
   - [x] Fuel cost for all thermal plants across all time periods
   - [x] Startup and shutdown costs for thermal unit commitment
   - [x] Terminal period water value from FCF curves
   - [x] Load shedding penalty variables and costs
   - [x] Numerical scaling (1e-6 factor)
</verification>

<success_criteria>
- COST_SCALE = 1e-6 constant defined and applied to all cost terms
- FCF curves integrated for terminal period water values
- Load shedding cost term works with new variables
- Deficit cost term works with new variables
- Test coverage >90% for production_cost.jl
- All Phase 1 requirements (OBJ-01 through OBJ-04) complete
- Code follows project style conventions
</success_criteria>

<output>
After completion, create `.planning/phases/01-objective-function-completion/01-03-SUMMARY.md`
</output>
